<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AI Asistan</title>
<style>
  :root{
    --accent: #ff6347;
    --muted: #f5f5f5;
    --card: #ffffff;
    --text: #222;
  }
  body{ margin:0; font-family: Arial, sans-serif; background:var(--muted); color:var(--text); }
  header{
    position: fixed; top:0; left:0; width:100%;
    background:var(--accent); color:white; display:flex; align-items:center;
    padding:10px 15px; box-shadow:0 2px 5px rgba(0,0,0,0.12); z-index:1000;
  }
  header a{ color:white; text-decoration:none; font-weight:bold; margin-right:15px; font-size:18px; }
  header span{ font-weight:600; }

  main{ margin-top:64px; padding:16px; padding-bottom:100px; max-width:900px; margin-left:auto; margin-right:auto; }

  /* Chat alanı */
  .chat-window{ display:flex; flex-direction:column; gap:12px; }
  .bubble { max-width: 100%; background:var(--card); padding:12px 14px; border-radius:12px; box-shadow:0 1px 4px rgba(0,0,0,0.06); }
  .bubble.user { align-self:flex-end; background:#ffecec; border:1px solid #ffd0c7; }
  .bubble.ai { align-self:flex-start; background:var(--card); }

  .section-title { font-weight:700; margin:8px 0; color:var(--accent); }
  .small { font-size:14px; color:#555; margin:4px 0; }

  /* recipe list table-like */
  .recipe-row { display:flex; justify-content:space-between; gap:12px; padding:8px; border-radius:8px; background:#fafafa; border:1px solid #f0f0f0; position:relative; }
  .recipe-row .left { font-weight:600; }
  .recipe-row .right { color:#666; min-width:80px; text-align:right; }

  /* önerilen tarif kutusu */
  .recommend { background:#fff; border-radius:10px; padding:12px; box-shadow:0 2px 8px rgba(0,0,0,0.06); }
  .missing-list { color:#b00; margin-top:8px; font-size:14px; }

  /* input alanı */
  .composer {
    position: fixed; left:0; right:0; bottom:0; display:flex; gap:10px;
    padding:10px; background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.02));
    justify-content:center;
  }
  .composer-inner { width:100%; max-width:900px; display:flex; gap:10px; padding:6px; }
  .composer input[type="text"]{ flex:1; padding:12px 14px; border-radius:10px; border:1px solid #ddd; font-size:16px; }
  .composer button{ background:var(--accent); color:white; border:none; padding:12px 18px; border-radius:10px; font-weight:700; cursor:pointer; }
  .composer button:active{ transform:translateY(1px); }

  /* yükleniyor */
  .spinner { width:18px; height:18px; border-radius:50%; border:3px solid rgba(0,0,0,0.1); border-left-color:var(--accent); animation:spin 1s linear infinite; display:inline-block; vertical-align:middle; margin-left:8px; }
  @keyframes spin{ to{ transform:rotate(360deg); } }

  /* responsive */
  @media (max-width:520px){
    .recipe-row { flex-direction:column; align-items:flex-start; }
    .recipe-row .right { text-align:left; }
  }
</style>
</head>
<body>
<header>
  <a href="/">← Ana Sayfa</a>
  <span>AI Asistan</span>
</header>

<main>
  <div id="chat" class="chat-window">
    <div class="bubble ai">
      Merhaba ben sanal yardımcı şefiniz! Lütfen ne istediğinizi söyleyiniz...
    </div>
  </div>
</main>

<!-- composer -->
<div class="composer">
  <div class="composer-inner">
    <input id="user-input" type="text" placeholder="Örn : Tatlı birşeyler yapalım!">
    <button id="send-btn">Gönder</button>
  </div>
</div>

<script>
const chat = document.getElementById('chat');
const input = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');

function appendBubble(text, cls='ai') {
  const div = document.createElement('div');
  div.className = 'bubble ' + cls;
  div.innerHTML = text;
  chat.appendChild(div);
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}

function esc(s){ return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }

async function sendMessage(){
  const text = input.value.trim();
  if(!text) return;
  appendBubble(esc(text), 'user');
  input.value=''; input.focus();

  const loading = document.createElement('div');
  loading.className = 'bubble ai';
  loading.innerHTML = 'Aranıyor... <span class="spinner"></span>';
  chat.appendChild(loading);
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });

  try {
    const res = await fetch('/ai_query', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ text })
    });
    const data = await res.json();
    loading.remove();

    if(!data || data.status !== 'ok'){
      appendBubble('Üzgünüm, sonuç alınamadı. ' + (data && data.message ? esc(data.message) : ''), 'ai');
      return;
    }

    const recipe_list = data.recipe_list || [];
    const dominanced_list = data.dominanced_list || [];

    // 1) Eşleşen tarifler
    let html = '<div class="section-title">Eşleşen Tarifler</div>';
    if(recipe_list.length === 0){
      html += '<div class="small">Hiç eşleşme bulunamadı.</div>';
    } else {
      recipe_list.forEach(r => {
        const title = esc(r.title || (r.id || 'İsim yok'));
        const score = (typeof r.final_score !== 'undefined') ? Number(r.final_score).toFixed(4) : '-';
        const rid = r.id || '';
        html += `<div class="recipe-row">
                   <div class="left">${title}</div>
                   <div class="right">${score}</div>
                   <button onclick="window.location.href='/recipe/${rid}'"
                     style="position:absolute; bottom:4px; right:4px; width:30px; height:30px;
                            border-radius:50%; border:none; background:var(--accent); color:white;
                            font-weight:bold; cursor:pointer;">→</button>
                 </div>`;
      });
    }
    appendBubble(html, 'ai');

    // 2) Önerilen tarif
    let recHtml = '<div class="section-title">Önerilen Tarif</div>';
    if(dominanced_list.length === 0){
      recHtml += '<div class="small">Önerilen tarif bulunamadı.</div>';
    } else {
      const sorted = dominanced_list.slice().sort((a,b)=>{
        const aa = (typeof a.adjusted_score !== 'undefined') ? a.adjusted_score : a.final_score || 0;
        const bb = (typeof b.adjusted_score !== 'undefined') ? b.adjusted_score : b.final_score || 0;
        return bb - aa;
      });
      const top = sorted[0];
      const topTitle = esc(top.title || top.id || 'İsim yok');
      const adj = (typeof top.adjusted_score !== 'undefined') ? Number(top.adjusted_score).toFixed(4) : (typeof top.final_score !== 'undefined' ? Number(top.final_score).toFixed(4) : '-');
      recHtml += `<div class="recommend"><div style="font-weight:700">${topTitle}</div>
                  <div class="small">Adjusted score: ${adj}</div>`;
      if(Array.isArray(top.missing) && top.missing.length){
        recHtml += `<div class="missing-list">Eksik malzemeler: ${esc(top.missing.join(', '))}</div>`;
      } else {
        recHtml += `<div class="small">Eksik malzeme yok gibi görünüyor.</div>`;
      }
      recHtml += `</div>`;
    }
    appendBubble(recHtml, 'ai');

  } catch (err) {
    loading.remove();
    appendBubble('Sunucu hatası: ' + esc(err.message || err), 'ai');
    console.error(err);
  }
}

sendBtn.addEventListener('click', sendMessage);
input.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') sendMessage(); });
window.addEventListener('load', ()=>{ input.focus(); });
</script>
</body>
</html>
