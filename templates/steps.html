<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{ recipe.title }} - Adımlar</title>
<style>
body { font-family: Arial, sans-serif; margin:0; background:#f9f9f9; }
header {
    position: fixed; top:0; width:100%; background:#ff6347; color:white; display:flex; align-items:center; padding:10px 15px; box-shadow:0 2px 5px rgba(0,0,0,0.1); z-index:1000;
}
header a { color:white; text-decoration:none; font-weight:bold; margin-right:15px; font-size:18px; }
main { margin-top:60px; padding:20px; }
.step { background:white; padding:20px; margin-bottom:15px; border-radius:10px; box-shadow:0 1px 5px rgba(0,0,0,0.1); }
.step p { margin:0 0 10px 0; }
.timer { font-weight:bold; color:#ff6347; font-size:16px; margin-top:10px; }
.start-timer-btn { background:#ff6347; color:white; border:none; padding:8px 15px; border-radius:10px; cursor:pointer; font-weight:bold; margin-top:10px; transition: transform 0.2s; }
.start-timer-btn:hover { transform:scale(1.05); }
.next-btn { margin-top:20px; padding:12px 25px; background:#ff6347; color:white; border:none; border-radius:15px; font-size:18px; cursor:pointer; }
.modal { display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,0.5); }
.modal-content { background:white; margin:20% auto; padding:20px; border-radius:15px; width:80%; max-width:300px; text-align:center; }
.modal-content button { padding:10px 20px; margin:10px; border-radius:10px; border:none; font-weight:bold; cursor:pointer; }
.modal-content .yes-btn { background:#ff6347; color:white; }
.modal-content .no-btn { background:#ccc; color:#333; }
#finish-btn { padding:15px 40px; font-size:20px; border-radius:20px; }
</style>
</head>
<body>

<header>
    <a href="/recipe/{{ recipe.id }}">←</a>
    <span>{{ recipe.title }} - Adımlar</span>
</header>

<main>
    <div id="step-container"></div>
    <button id="next-btn" class="next-btn" onclick="handleNext()">Sonraki Adım</button>
</main>


<div id="confirm-modal" class="modal">
    <div class="modal-content">
        <p>Sonraki adıma geçmek istediğinizden emin misiniz?</p>
        <button class="yes-btn" onclick="confirmNext()">Evet</button>
        <button class="no-btn" onclick="closeModal()">Hayır</button>
    </div>
</div>

<script>
const steps = {{ recipe.steps | tojson }};
let currentStep = 0;
const container = document.getElementById("step-container");
const nextBtn = document.getElementById("next-btn");
const modal = document.getElementById("confirm-modal");

function showStep(index) {
    if(index >= steps.length){
        // bitir butonu adımı
        container.innerHTML = `<div style="text-align:center; margin-top:50px;">
            <button id="finish-btn" class="next-btn" onclick="finishRecipe('{{ recipe.id }}')">Bitir</button>
        </div>`;
        nextBtn.style.display = "none";
        return;
    }

    const step = steps[index];
    let html = `<div class="step"><p>${step.aciklama}</p>`;

    if(step.asama_turu==="kronometre" && step.kronometre_suresi){
        html += `<button class="start-timer-btn" onclick="startTimer('${step.kronometre_suresi}', this)">Başlat</button>`;
        html += `<div class="timer" id="timer">Kronometre: ${step.kronometre_suresi}</div>`;
    }

    html += `</div>`;
    container.innerHTML = html;
    nextBtn.style.display = "inline-block";
}

function startTimer(duration, btn){
    let seconds = duration.endsWith("m") ? parseInt(duration)*60 : parseInt(duration);
    const timerEl = document.getElementById("timer");
    btn.disabled=true;
    const interval = setInterval(()=>{
        let mins = Math.floor(seconds/60);
        let secs = seconds%60;
        timerEl.textContent = `Kronometre: ${mins}m ${secs}s`;
        seconds--;
        if(seconds<0){ clearInterval(interval); timerEl.textContent="Kronometre tamamlandı!"; }
    },1000);
}

function handleNext(){
    const step = steps[currentStep];
    if(step.asama_turu==="kronometre" && step.kronometre_suresi){
        showConfirmModal();
    } else { goNextStep(); }
}

function goNextStep(){ currentStep++; showStep(currentStep); }

function showConfirmModal(){ modal.style.display="block"; }
function closeModal(){ modal.style.display="none"; }
function confirmNext(){ modal.style.display="none"; goNextStep(); }
window.onclick = function(event){ if(event.target==modal) modal.style.display="none"; }

// Bitir butonu
function finishRecipe(recipeId){
    fetch(`/add_to_history/${recipeId}`, { method:"POST" })
    .then(res=>res.json())
    .then(data=>{
        const msgDiv=document.createElement("div");
        msgDiv.textContent="Tebrikler tarif tamamlandı!!";
        msgDiv.style.position="fixed";
        msgDiv.style.top="50%";
        msgDiv.style.left="50%";
        msgDiv.style.transform="translate(-50%,-50%)";
        msgDiv.style.background="white";
        msgDiv.style.padding="30px 60px";
        msgDiv.style.borderRadius="20px";
        msgDiv.style.boxShadow="0 2px 10px rgba(0,0,0,0.3)";
        msgDiv.style.fontWeight="bold";
        msgDiv.style.fontSize="22px";
        document.body.appendChild(msgDiv);
        setTimeout(()=>{ window.location.href="/"; },3000);
    }).catch(err=>console.error(err));
}

// ilk adımı göster
showStep(currentStep);
</script>
</body>
</html>
